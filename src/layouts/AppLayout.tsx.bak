// src/layouts/AppLayout.tsx
import React, { useEffect, useState } from 'react';
import { Outlet, useLocation } from 'react-router-dom';

import SiteHeader from '@/components/Header/SiteHeader';
import SiteFooter from '@/components/Footer/SiteFooter';

import Modal from '@/components/Common/Modal';
import Login from '@/components/Authentication/Login';
import Signup from '@/components/Authentication/Signup';
import Logout from '@/components/Authentication/Logout';

// Load global styles once here
import '@/App.scss';
import '@/assets/sass/layout/_grid.scss';
import '@/assets/sass/layout/_forms.scss';

function AuthModalsHost() {
  const [loginOpen, setLoginOpen] = useState(false);
  const [signupOpen, setSignupOpen] = useState(false);
  const [logoutOpen, setLogoutOpen] = useState(false);

  useEffect(() => {
    const onLogin  = () => setLoginOpen(true);
    const onSignup = () => setSignupOpen(true);
    const onLogout = () => setLogoutOpen(true);

    // Listeners for events dispatched by UserMenu defaults
    document.addEventListener('auth:login',  onLogin as EventListener);
    document.addEventListener('auth:signup', onSignup as EventListener);
    document.addEventListener('auth:logout', onLogout as EventListener);

    return () => {
      document.removeEventListener('auth:login',  onLogin as EventListener);
      document.removeEventListener('auth:signup', onSignup as EventListener);
      document.removeEventListener('auth:logout', onLogout as EventListener);
    };
  }, []);

  return (
    <>
      <Modal isOpen={loginOpen} onClose={() => setLoginOpen(false)}>
        <Login />
      </Modal>

      <Modal isOpen={signupOpen} onClose={() => setSignupOpen(false)}>
        <Signup />
      </Modal>

      <Modal isOpen={logoutOpen} onClose={() => setLogoutOpen(false)}>
        <Logout />
      </Modal>
    </>
  );
}

export default function AppLayout() {
  // Close any open menus/modals on route change (optional nicety)
  const { pathname } = useLocation();
  useEffect(() => {
    document.dispatchEvent(new CustomEvent('ui:route-changed'));
  }, [pathname]);

  return (
    <div className="app-shell">
      <SiteHeader />
      <main className="app-main">
        <Outlet />
      </main>
      <SiteFooter />
      <AuthModalsHost />
    </div>
  );
}
