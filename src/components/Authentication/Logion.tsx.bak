
// src/components/Authentication/Login.tsx
import React, { useState } from 'react'
import { Amigo } from '../../types/AmigoTypes'
import Modal from '../Common/Modal'
import '../../assets/sass/components/_authentication.scss'
// import { publicPost } from '../../services/apiHelper'
import { ensureCsrfToken } from '../../services/csrf'
import publicApi from '../../services/publicApi'

interface LoginProps {
  isOpen: boolean
  onClose: () => void
  onLoginSuccess: (amigo: Amigo) => void
}

// interface LoginResponse {
// amigo: Amigo
//   jwt_expires_at: string
// }

const Login: React.FC<LoginProps> = ({ isOpen, onClose, onLoginSuccess }) => {
  const [loginAttribute, setLoginAttribute] = useState('')
  const [password, setPassword] = useState('')
  const [errorMessage, setErrorMessage] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  const handleErrorResponse = (status: number) => {
    switch (status) {
      case 401:
        setErrorMessage('Invalid login credentials.')
        break
      case 500:
        setErrorMessage('Server error. Please try again later.')
        break
      default:
        setErrorMessage('An error occurred. Please try again.')
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setErrorMessage(null)
    if (!loginAttribute || !password) {
      setErrorMessage('Please fill in both fields.')
      return
    }

    try {
      setLoading(true)
      const csrfToken = await ensureCsrfToken()

      const response = await publicApi.post(
        '/api/v1/login',
        { amigo: { login_attribute: loginAttribute, password } },
        {
          headers: {
            'X-CSRF-Token': csrfToken,
            'Content-Type': 'application/json',
          },
          withCredentials: true, // should already be true on the instance but explicit is fine
        }
      )

      const { amigo } = (response.data as any).data
      onLoginSuccess(amigo)
      onClose()

    } catch (err: any) {
      if (err.response) {
        handleErrorResponse(err.response.status)
      } else {
        setErrorMessage('An error occurred during login. Please try again later.')
      }
    } finally {
      setLoading(false)
    }
  }

  if (!isOpen) return null

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <form className="auth-form" onSubmit={handleSubmit}>
        <label className="auth-form__label">
          Username, Email, or Phone No.
          <input
            type="text"
            className="auth-form__input"
            value={loginAttribute}
            onChange={(e) => setLoginAttribute(e.target.value)}
            disabled={loading}
            required
          />
        </label>
        <label className="auth-form__label">
          Password
          <input
            type="password"
            className="auth-form__input"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            disabled={loading}
            required
          />
        </label>
        <button type="submit" className="auth-form__button" disabled={loading}>
          {loading ? 'Logging in...' : 'Login'}
        </button>
        {errorMessage && <p className="auth-form__error-message">{errorMessage}</p>}
      </form>
    </Modal>
  )
}

export default Login
