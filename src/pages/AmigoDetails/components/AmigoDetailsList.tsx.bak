// src/pages/AmigoDetails/components/AmigoDetailsList.tsx
import React, { useEffect, useState } from "react";
import AmigoDetailsItem from "./AmigoDetailsItem";
import type { AmigoDetails } from "@/types/amigos/AmigoDetailsTypes";
import type { Amigo } from "@/types/amigos/AmigoTypes";
import privateApi from "@/services/api/privateApi";
import useAuth from "@/hooks/useAuth";
import UniversalCard from "@/components/cards/UniversalCard";
import styles from "../AmigoDetails.module.scss";

interface AmigoWithDetails {
  amigo: Amigo;
  amigoDetails: AmigoDetails;
}

const AmigoDetailsList: React.FC = () => {
  const { amigos, loading: authLoading } = useAuth();
  const [amigosWithDetails, setAmigosWithDetails] = useState<AmigoWithDetails[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (authLoading) return;

    if (!amigos.length) {
      setAmigosWithDetails([]);
      setLoading(false);
      return;
    }

    const fetchAmigosWithDetails = async () => {
      setLoading(true);
      setError(null);

      try {
        const amigoDetails = await Promise.all(
          amigos.map(async (amigo: Amigo) => {
            const detailsRes = await privateApi.get<AmigoDetails>(
              `/api/v1/amigos/${amigo.id}/amigo_detail`,
            );
            return { amigo, amigoDetails: detailsRes.data };
          }),
        );

        setAmigosWithDetails(amigoDetails);
      } catch (err) {
        console.error("Error fetching amigo details", err);
        setError("Error fetching amigo details");
        setAmigosWithDetails([]);
      } finally {
        setLoading(false);
      }
    };

    void fetchAmigosWithDetails();
  }, [amigos, authLoading]);

  if (loading) return <p>Loading...</p>;
  if (error) return <p>{error}</p>;

  if (!amigosWithDetails.length) {
    return <p>No amigos found.</p>;
  }

  return (
    <div className="amigo-detail-list">
      {amigosWithDetails.map(({ amigo, amigoDetails }) => {
        const headingId = `amigo-details-heading-${amigo.id}`;
        return (
          <UniversalCard
            key={amigo.id}
            titleId={headingId}
            className={styles.amigoDetailsCard}
          >
            <AmigoDetailsItem
              amigo={amigo}
              amigoDetails={amigoDetails}
              headingId={headingId}
            />
          </UniversalCard>
        );
      })}
    </div>
  );
};

export default AmigoDetailsList;
