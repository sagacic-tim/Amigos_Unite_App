// src/pages/AmigoDetails/components/AmigoDetailsItem.tsx
import React from "react";
import type { AmigoDetails } from "@/types/amigos/AmigoDetailsTypes";
import type { Amigo } from "@/types/amigos/AmigoTypes";
import { buildAvatarUrl, DEFAULT_AVATAR } from "@/utils/avatar";
import useAuth from "@/hooks/useAuth";

interface AmigoDetailsItemProps {
  amigoDetails: AmigoDetails | null;
  amigo: Amigo;
  /** Optional heading id so the wrapper card/modal can reference it */
  headingId?: string;
}

const EXCLUDED_DETAIL_KEYS = new Set([
  "id",
  "amigo",
  "amigo_id",
  "locations",
  "avatar_url", // snake_case
  "avatar-url", // kebab-case
]);

const formatString = (key: string): string =>
  key.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());

const AmigoDetailsItem: React.FC<AmigoDetailsItemProps> = ({
  amigoDetails,
  amigo,
  headingId,
}) => {
  const { currentAmigo } = useAuth();

  // If this is the logged-in amigo, prefer currentAmigo
  const effectiveAmigo: Amigo =
    currentAmigo && currentAmigo.id === amigo.id
      ? { ...amigo, ...currentAmigo }
      : amigo;

  const firstName = effectiveAmigo.first_name || "Unknown";
  const lastName = effectiveAmigo.last_name || "Unknown";
  const computedHeadingId =
    headingId ?? `amigo-details-heading-${effectiveAmigo.id}`;

  const avatarSrc = buildAvatarUrl(effectiveAmigo);

  const handleImgError = (e: React.SyntheticEvent<HTMLImageElement>) => {
    const img = e.currentTarget;
    if (img.dataset.fallbackApplied === "true") return; // avoid loops
    img.dataset.fallbackApplied = "true";
    img.src = DEFAULT_AVATAR;
  };

  const renderAvatarBlock = () => (
    <div className="card__avatar-block">
      <span className="avatar avatar--lg">
        <img
          src={avatarSrc}
          alt={`${firstName} {lastName}`}
          onError={handleImgError}
          loading="lazy"
        />
      </span>
      <span>Shown across the app</span>
    </div>
  );

  if (!amigoDetails) {
    return (
      <>
        <h3 className="card__title" id={computedHeadingId}>
          Details for {firstName} {lastName}
        </h3>

        {renderAvatarBlock()}

        <p className="card__message">Message: No details information found.</p>
      </>
    );
  }

  const detailFields = Object.entries(amigoDetails).filter(
    ([key, value]) =>
      value !== null &&
      value !== undefined &&
      !EXCLUDED_DETAIL_KEYS.has(key) &&
      typeof value !== "object",
  );

  return (
    <>
      <h3 className="card__title" id={computedHeadingId}>
        Details for {firstName} {lastName}
      </h3>

      {renderAvatarBlock()}

      <ul className="card__fields">
        <li className="card__field">
          <span className="card__field-label">Amigo Id:</span>
          {effectiveAmigo.id}
        </li>

        {detailFields.length > 0 ? (
          detailFields.map(([key, value]) => {
            const display =
              typeof value === "boolean" ? (value ? "Yes" : "No") : String(value);
            return (
              <li key={key} className="card__field prose">
                <span className="card__field-label">
                  {formatString(key)}:
                </span>
                {display}
              </li>
            );
          })
        ) : (
          <li className="card__field">No additional details found.</li>
        )}
      </ul>
    </>
  );
};

export default AmigoDetailsItem;
