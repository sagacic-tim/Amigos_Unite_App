// src/pages/Amigos/components/AmigoItem.tsx
import { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import useAuth from "@/hooks/useAuth";
import UniversalModal from "@/components/modals/UniversalModal";
import UniversalCard from "@/components/cards/UniversalCard";
import AmigoDetailItem from "@/pages/AmigoDetails/components/AmigoDetailsItem";
import AmigoLocationItem from "@/pages/AmigoLocations/components/AmigoLocationItem";
import { fetchAmigoDetails, fetchAmigoLocations } from "@/services/AmigoService";
import type { Amigo } from "@/types/amigos/AmigoTypes";
import type { AmigoDetails } from "@/types/amigos/AmigoDetailsTypes";
import type { AmigoLocation } from "@/types/amigos/AmigoLocationTypes";
import { buildAvatarUrl, DEFAULT_AVATAR } from "@/utils/avatar";

interface AmigoItemProps {
  amigo: Amigo;
}

const AmigoItem: React.FC<AmigoItemProps> = ({ amigo }) => {
  const navigate = useNavigate();
  const { currentAmigo } = useAuth();

  const canEdit = !!currentAmigo && currentAmigo.id === amigo.id;

  const effectiveAmigo = useMemo<Amigo>(() => {
    if (currentAmigo && currentAmigo.id === amigo.id) {
      return { ...amigo, ...currentAmigo };
    }
    return amigo;
  }, [amigo, currentAmigo]);

  const avatarUrl = useMemo(
    () => buildAvatarUrl(effectiveAmigo),
    [effectiveAmigo],
  );

  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
  const [isLocationModalOpen, setIsLocationModalOpen] = useState(false);
  const [amigoDetail, setAmigoDetail] = useState<AmigoDetails | null>(null);
  const [amigoLocations, setAmigoLocations] = useState<AmigoLocation[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const detailHeadingId = `amigo-details-heading-${effectiveAmigo.id}`;
  const locationHeadingId = `amigo-locations-heading-${effectiveAmigo.id}`;

  const handleImgError = (e: React.SyntheticEvent<HTMLImageElement>) => {
    const img = e.currentTarget;
    if (img.dataset.fallbackApplied === "true") return;
    img.dataset.fallbackApplied = "true";
    img.src = DEFAULT_AVATAR;
  };

  const handleOpenDetailModal = async () => {
    setIsDetailModalOpen(true);
    setLoading(true);
    setError(null);
    try {
      const data = await fetchAmigoDetails(effectiveAmigo.id);
      if (!data || (typeof data === "object" && Object.keys(data).length === 0)) {
        setError("No Details Information Found");
        setAmigoDetail(null);
      } else {
        setAmigoDetail(data);
      }
    } catch (err) {
      console.error("Error fetching amigo details:", err);
      setError("Error loading amigo details.");
      setAmigoDetail(null);
    } finally {
      setLoading(false);
    }
  };

  const handleOpenLocationModal = async () => {
    setIsLocationModalOpen(true);
    setLoading(true);
    setError(null);
    try {
      const list = await fetchAmigoLocations(effectiveAmigo.id);
      setAmigoLocations(Array.isArray(list) ? list : []);
    } catch (err) {
      console.error("Error fetching amigo locations:", err);
      setError("Error loading amigo locations.");
      setAmigoLocations([]);
    } finally {
      setLoading(false);
    }
  };

  const handleCloseModal = () => {
    setIsDetailModalOpen(false);
    setIsLocationModalOpen(false);
    setAmigoDetail(null);
    setAmigoLocations([]);
    setError(null);
  };

  return (
    <article className="card card--profile">
      <div className="card__media card__media--avatar">
        <img
          src={avatarUrl}
          alt={`${effectiveAmigo.first_name} ${effectiveAmigo.last_name}'s avatar`}
          loading="lazy"
          onError={handleImgError}
        />
      </div>

      <div className="card__body">
        <h3 className="card__title">
          {effectiveAmigo.first_name} {effectiveAmigo.last_name}
        </h3>

        <ul className="card__list">
          {Object.entries(effectiveAmigo).map(([key, value]) => {
            if (
              value == null ||
              [
                "id",
                "avatar_url",
                "avatar-url",
                "created_at",
                "updated_at",
                "unformatted_phone_1",
                "unformatted_phone_2",
              ].includes(key)
            ) {
              return null;
            }
            const display =
              typeof value === "boolean" ? (value ? "Yes" : "No") : String(value);
            return (
              <li key={key} className="card__list-item">
                <span className="card__label">
                  {key.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase())}:
                </span>
                {display}
              </li>
            );
          })}
        </ul>

        <div className="card__actions">
          <button
            className="button button--secondary"
            onClick={handleOpenDetailModal}
          >
            View Details
          </button>
          <button
            className="button button--secondary"
            onClick={handleOpenLocationModal}
          >
            View Address(es)
          </button>

          {canEdit && (
            <button
              className="button button--primary"
              onClick={() => navigate("/user-profile?edit=amigo")}
            >
              Edit Profile
            </button>
          )}
        </div>
      </div>

      {/* Details modal */}
      <UniversalModal
        isOpen={isDetailModalOpen}
        onClose={handleCloseModal}
        titleId={detailHeadingId}
      >
        <UniversalCard titleId={detailHeadingId}>
          {loading ? (
            <p>Loading...</p>
          ) : error ? (
            <p>{error}</p>
          ) : (
            <AmigoDetailItem
              amigoDetails={amigoDetail}
              amigo={effectiveAmigo}
              headingId={detailHeadingId}
            />
          )}
        </UniversalCard>
      </UniversalModal>

      {/* Locations modal */}
      <UniversalModal
        isOpen={isLocationModalOpen}
        onClose={handleCloseModal}
        titleId={locationHeadingId}
      >
        <UniversalCard titleId={locationHeadingId}>
          {loading ? (
            <p>Loading...</p>
          ) : error ? (
            <p>{error}</p>
          ) : amigoLocations.length > 0 ? (
            amigoLocations.map((location) => (
              <AmigoLocationItem
                key={location.id}
                location={location}
                amigo={effectiveAmigo}
              />
            ))
          ) : (
            <AmigoLocationItem location={null} amigo={effectiveAmigo} />
          )}
        </UniversalCard>
      </UniversalModal>
    </article>
  );
};

export default AmigoItem;
