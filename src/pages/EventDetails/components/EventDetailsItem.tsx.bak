// src/pages/EventDetails/components/EventDetailsItem.tsx
import React from "react";
import type { Event as EventModel } from "@/types/events";
import styles from "../EventDetail.module.scss";

interface EventDetailsItemProps {
  event: EventModel;
  /**
   * Optional callback for "View Location".
   * If omitted, this will dispatch a CustomEvent("events:view-location", { detail: { eventId } }).
   */
  onViewLocationClick?: (eventId: number) => void;
}

function formatStatus(status: EventModel["status"], label?: string): string {
  if (label) return label;
  if (!status) return "";
  return status.charAt(0).toUpperCase() + status.slice(1);
}

const EventDetailsItem: React.FC<EventDetailsItemProps> = ({
  event,
  onViewLocationClick,
}) => {
  const {
    id,
    event_name,
    event_date,
    event_time,
    status,
    status_label,
    event_type,
    event_speakers_performers,
    description,
    formatted_event_date,
    formatted_event_time,
  } = event;

  const headingId = `event-details-heading-${id}`;

  const whenDate = formatted_event_date ?? event_date;
  const whenTime =
    formatted_event_time ??
    (event_time && event_time.length >= 5 ? event_time.slice(0, 5) : event_time);

  const speakers =
    event_speakers_performers?.filter(Boolean).join(", ") ?? "";

  const humanStatus = formatStatus(status, status_label);

  const handleViewLocation = () => {
    if (onViewLocationClick) {
      onViewLocationClick(id);
      return;
    }

    // Fallback: event-bus style trigger
    document.dispatchEvent(
      new CustomEvent("events:view-location", {
        detail: { eventId: id },
      }),
    );
  };

  return (
    <article
      className={`card card--details ${styles.eventDetailsCard}`}
      aria-labelledby={headingId}
    >
      <h3 className="card__title" id={headingId}>
        {event_name}
      </h3>

      {/* Meta line: date · time · type */}
      <p className={styles.metaLine}>
        {whenDate && (
          <span className={styles.metaItem}>
            {whenDate}
          </span>
        )}
        {whenTime && (
          <span className={styles.metaItem}>
            {whenDate ? " • " : ""}
            {whenTime}
          </span>
        )}
        {event_type && (
          <span className={styles.metaItem}>
            {(whenDate || whenTime) ? " • " : ""}
            {event_type}
          </span>
        )}
      </p>

      {/* Core fields */}
      <ul className="card__fields">
        <li className="card__field">
          <span className="card__field-label">Status:</span>
          <span>{humanStatus}</span>
        </li>

        {speakers && (
          <li className="card__field">
            <span className="card__field-label">
              Speakers / Performers:
            </span>
            <span>{speakers}</span>
          </li>
        )}
      </ul>

      {/* Description */}
      {description && description.trim().length > 0 && (
        <>
          <h4 className={styles.subheading}>Description</h4>
          <p className="card__message">{description}</p>
        </>
      )}

      {/* Actions pinned to bottom via .card__actions */}
      <div className="card__actions">
        <button
          type="button"
          className="button button--secondary"
          onClick={handleViewLocation}
        >
          View Location
        </button>
      </div>
    </article>
  );
};

export default EventDetailsItem;
